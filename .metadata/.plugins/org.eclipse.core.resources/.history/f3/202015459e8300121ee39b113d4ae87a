package com.fer.smsc.broadcast;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.telephony.SmsManager;
import android.telephony.SmsMessage;
import android.util.Log;

import com.fer.smsc.model.MessageParser;
import com.fer.smsc.model.SolicitudServicio;

public class SmsReceiver extends BroadcastReceiver {
	
	    private static final String SMS_RECEIVED = "android.provider.Telephony.SMS_RECEIVED";
	    private static final String TAG = "smsfwd";
	    
	    private static MessageParser messageParser;
	    
	    public SmsReceiver() {
	    	if (messageParser == null)
	    	{
	    		messageParser = new MessageParser();
	    	}
		}

	    @Override
	    public void onReceive(Context context, Intent intent) {

	        if (intent.getAction().equals(SMS_RECEIVED)) {
	            Bundle bundle = intent.getExtras();
	            if (bundle != null) {
	                Object[] pdus = (Object[])bundle.get("pdus");
	                final SmsMessage[] messages = new SmsMessage[pdus.length];
	                for (int i = 0; i < pdus.length; i++) {
	                    messages[i] = SmsMessage.createFromPdu((byte[])pdus[i]);
	                }
	                if (messages.length > -1) {
	                    Log.i(TAG, "Message recieved: " + messages[0].getMessageBody()+" from: "+messages[0].getOriginatingAddress());
	                    String messageBody = messages[0].getMessageBody();
	                    String sender = messages[0].getOriginatingAddress();
	                    if (messageParser.isConfirmarTaxi(messageBody))
	                    {
	                    	SolicitudServicio solicitud = messageParser.getServicioConfirmado(messageBody);
	                    	SmsManager.getDefault().sendTextMessage(destinationAddress, scAddress, text, sentIntent, deliveryIntent);
	                    	System.out.println(solicitud);
	                    }
	                    else if (messageParser.isSolicitarServicio(messageBody))
	                    {
	                    	SolicitudServicio solicitud = messageParser.getSolicitudServicio(messageBody, sender);
	                    	
	                    }
	                }
	            }
	        }
	    }
	}


